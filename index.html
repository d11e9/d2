<html>
    <head>
        <title>d2 App</title>
        <script src="assets/poly-eth/index.js"></script>
        <script src="assets/jquery-1.10.2.js"></script>
        <link rel="stylesheet" href="assets/style.css">
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
        <script src="http://localhost:9091/transmission/web/script/min/transmission.js?v=20130913"></script>
    </head>
    <body onload="init();">

        <div id="header">
            <h1><i class="fa fa-file-text-o"></i> Dox</h1>
            <div class="info">
                <a href="magnet:?xt=urn:btih:3EB0B04E8A6819A732BEAC1F738043E8793FD80F&dn=d2.md&tr=udp%3a%2f%2ftracker.openbittorrent.com%3a80%2fannounce&tr=udp%3a%2f%2ftracker.publicbt.com%3a80%2fannounce&tr=udp%3a%2f%2ftracker.ccc.de%3a80%2fannounce">
                    Documentation
                </a>
                (<a href="#" title="No torrent support yet in EtheremClient">Why a Magnet Link?</a>)
            </div>          
        </div>

        <div id="warning" class="output">
            
        </div>

        <div id="content">
            <div id="view-form">
                <input class="" type="text" value="12a3a3Ia43L5UAsaGSIDd" placeholder="Address">
                <button class="submit">View</button>
            </div>
            <div id="feedback" class="output">
                
            </div>
            <div id="view-output">              

            </div>
        </div>



        <div id="debug-output" class="output">
            
        </div>

        <div id="demo-output">              
            Documentation for (ADDRESS): <a href="magnet:?xt=urn:btih:3EB0B04E8A6819A732BEAC1F738043E8793FD80F&dn=d2.md&tr=udp%3a%2f%2ftracker.openbittorrent.com%3a80%2fannounce&tr=udp%3a%2f%2ftracker.publicbt.com%3a80%2fannounce&tr=udp%3a%2f%2ftracker.ccc.de%3a80%2fannounce">Magnet Link</a>
            <p>
                <code>
                    magnet:?xt=urn:btih:3EB0B04E8A6819A732BEAC1F738043E8793FD80F&dn=d2.md&tr=udp%3a%2f%2ftracker.openbittorrent.com%3a80%2fannounce&tr=udp%3a%2f%2ftracker.publicbt.com%3a80%2fannounce&tr=udp%3a%2f%2ftracker.ccc.de%3a80%2fannounc
                </code>
            </p>
        </div>


        <script type="text/javascript">

            var D2_CONTRACT_ADDRESS = "asdasd";

            function content_hash(address) {
                alert( 'content_hash for ' + address )
                var content_hash = eth.getStorageAt( D2_CONTRACT_ADDRESS, address ) || "No ETH Connection"
                return content_hash;
            }

            function handleViewClick() {
                output( '#feedback', 'success', "Not connected, showing demo documentation in the meantime" );
                document.querySelector("#view-output").innerHTML = document.querySelector("#demo-output").innerHTML;
            }

            function output (selector, classes, content) {
                var output = document.querySelector( selector )
                var out = document.createElement( 'div' );
                var close = document.createElement( 'div' );
                out.className = classes;
                close.className = 'close fa fa-times-circle'
                out.innerHTML = content;
                out.appendChild( close );
                output.appendChild( out );

                close.onclick = function() {
                    output.removeChild( out )
                }
            }

            function fetchTorrentData ( sessionId ) {
                jQuery.ajax({
                    // transmission daemon REST api
                    url: 'http://localhost:9292/localhost:9091/transmission/rpc',
                    type: 'POST',
                    method: 'POST',
                    contentType: 'json',
                    dataType: 'json',
                    cache: false,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader( 'X-Transmission-Session-Id', sessionId );
                    },
                    data: {
                       "arguments": {
                           "fields": [ "id", "name", "totalSize" ],
                           "ids": [ 7, 10 ]
                       },
                       "method": "torrent-get"
                    },
                    error: function(res) {
                        console.log( res )
                        output( '#debug-output', 'warning', "Transmission RPC Error: " + res + ". Most likely due to CORS restrictions. Use corsproxy." );
                    },
                    success: function(res) {
                        console.log( res )
                        output( '#debug-output', 'success', "Transmission RPC: " + res.result );
                    }
                });
            }

            function initUI () {
                
                if (typeof eth === 'undefined') {
                    output( '#warning', 'warning', "No ETH Object Available. Dox must be run within an Ethereum Browser." );
                    var e = polyeth()
                } else {
                    var e = polyeth(eth)
                }



                jQuery('#view-form button').click( handleViewClick );

                e.getKey( function(key){
                    output( "#debug-output", 'success', 'Ethereum Key: ' + key );
                });


                fetchTorrentData('X3bTJ7rAG00qNANlPZemveZTdq0H4kWYNq3NWw5h3vLQVdCo');
                
            }
            
            function init() { 
                jQuery( document ).ready( initUI ); 
            }

        </script>
    </body>
</html>

